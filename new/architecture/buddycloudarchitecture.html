<html><head><title>buddycloud architecture</title>
</head><body class="c13"><p class="c2 title"><a name="h.ymiewjtztoxf"></a><span>buddycloud architecture</span></p><p class="c2 c5"><span></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.7x6h89rpybm9">Distributed design</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.lwesbbz2uxh9">Federating with other buddycloud servers</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.3ugd4ob1elsb">Home and remote buddycloud servers</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.mizxkzd62mj9">The buddycloud Inbox</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.7kmli87os30d">Data Storage</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.pp15h6jwejzn">Resynchronising with remote domains</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.s6kwnujdo8x2">Strong Identity</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.bpgc5hdunk4n">Messaging</a></span></p><p class="c12 c2"><span class="c0"><a class="c4" href="#h.it59tzhbxh4p">client to server messages</a></span></p><p class="c2 c12"><span class="c0"><a class="c4" href="#h.fyaih0gpjfby">server to server messages</a></span></p><p class="c1"><span class="c0"><a class="c4" href="#h.mjhwqvkmrqj0">Protocol checking</a></span></p><h2 class="c2"><a name="h.7x6h89rpybm9"></a><span>Distributed design</span></h2><p class="c2"><span>buddycloud is designed to be fully distributed. Much like how you can email someone on a different domain, buddycloud let&#39;s you share with users on your site, and remote buddycloud-enabled sites.</span></p><h2 class="c2"><a name="h.lwesbbz2uxh9"></a><span>Federating with other buddycloud servers</span></h2><p class="c2"><span>buddycloud abstracts the finding, connecting to and communicating with remote buddycloud servers to the local XMPP server. The XMPP server is thus responsible for</span></p><ol class="c11" start="1"><li class="c8 c2"><span>DNS discovery of the remote XMPP server</span></li><li class="c8 c2"><span>connecting to and negotiating an encrypted stream with the remote server</span></li><li class="c8 c2"><span>exchanging buddycloud data</span></li><li class="c8 c2"><span>eventually expiring the connection if no subsequent traffic is sent or received (about 10 minutes)</span></li></ol><p class="c2"><span>This approach proves to be very robust and enables clean separation between buddycloud application logic and federation operations.</span></p><h2 class="c2"><a name="h.3ugd4ob1elsb"></a><span>Home and remote buddycloud servers</span></h2><p class="c2"><span>buddycloud clients, be they mobile or web connect to their home server. Their home server is responsible for hosting and sharing their data. </span></p><p class="c2 c5"><span></span></p><p class="c2"><span>The buddycloud protocol is broken down into two parts: how servers connect to share and push and retrieve data from remote servers and how buddycloud applications connect to their home server to retrieve updates. Clients always talk to their home server.</span></p><h2 class="c2"><a name="h.mizxkzd62mj9"></a><span>The buddycloud Inbox</span></h2><p class="c2"><span>The home buddycloud server maintains a &quot;social inbox&quot; for each user. This is list of events that have happened since that user was last online. For example post updates, and follow requests. </span></p><p class="c2 c5"><span></span></p><p class="c2"><span>The home server is also responsible for re-syncing with remote servers should it be offline or down for maintenance. This way the user&#39;s social inbox is always current.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>The buddycloud inbox approach means that the most current data is always available just one hop away from the mobile or webclient and information can be quickly updated when a client comes back online.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>When buddycloud apps are online, new content from buddycloud servers skipps the inbox and is pushed is pushed straight through to the buddycloud client.</span></p><p class="c2 c5"><span></span></p><h2 class="c2"><a name="h.bywbaav9obah"></a><span>Many small services</span></h2><p class="c2"><span>buddycloud&#39;s design is based on small services doing specific tasks. For example the media server just serves media based, the pusher service just deals with sending out push notifications to phones and alert emails. </span></p><p class="c2 c5"><span></span></p><p class="c2"><span>Each service can communicate with other services on local and the and remote buddycloud sites.</span></p><p class="c2 c5"><span></span></p><p class="c2 c5"><span></span></p><p class="c2"><img height="363" src="images/image00.png" width="539"></p><p class="c2 c5"><span></span></p><h2 class="c2"><a name="h.7kmli87os30d"></a><span>Data Storage</span></h2><p class="c2"><span>buddycloud is essentially a giant publish subscribe service. You can think of buddycloud channels as publish-subscribe nodes backed by application logic of what can read and write to each node.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>buddycloud uses a SQL database to store the state and history of each of these nodes. Other buddycloud components implement their own data storage. A quick break down is as follows:</span></p><p class="c2 c5"><span></span></p><a href="#" name="651e3161c3a2d6ca4e6120845fe3856ccc866526"></a><a href="#" name="0"></a><table cellpadding="0" cellspacing="0" class="c14"><tbody><tr><td class="c7"><p class="c3 c2 c5"><span></span></p></td><td class="c7"><p class="c3 c2"><span>Database</span></p></td><td class="c7"><p class="c3 c2"><span>Disk storage</span></p></td></tr><tr class="c9"><td class="c7"><p class="c3 c2"><span>buddycloud server</span></p></td><td class="c7"><p class="c3 c2"><span>postgres or mysql</span></p></td><td class="c7"><p class="c3 c2 c5"><span></span></p></td></tr><tr class="c9"><td class="c7"><p class="c3 c2"><span>buddycloud media server</span></p></td><td class="c7"><p class="c3 c2"><span>postgres or mysql</span></p></td><td class="c7"><p class="c3 c2"><span>disk storage for individual media objects</span></p></td></tr><tr class="c9"><td class="c7"><p class="c3 c2"><span>buddycloud API server</span></p></td><td class="c7"><p class="c3 c2"><span>all state is stored in memory</span></p></td><td class="c7"><p class="c3 c2 c5"><span></span></p></td></tr><tr class="c9"><td class="c7"><p class="c3 c2"><span>buddycloud pusher</span></p></td><td class="c7"><p class="c3 c2"><span>postgres or mysql</span></p></td><td class="c7"><p class="c3 c2 c5"><span></span></p></td></tr><tr class="c6"><td class="c7"><p class="c3 c2"><span>buddycloud webclient</span></p></td><td class="c7"><p class="c3 c2"><span>posts and state are stored in IndexedDB on the webclient</span></p></td><td class="c7"><p class="c3 c2"><span>browser caching</span></p></td></tr><tr class="c9"><td class="c7"><p class="c3 c2"><span>buddycloud android client</span></p></td><td class="c7"><p class="c2 c3"><span>SQLlite to store posts and access credentials</span></p></td><td class="c7"><p class="c3 c2"><span>A disk cache is used to speed up access to avatars and media posts</span></p></td></tr></tbody></table><p class="c2 c5"><span></span></p><h2 class="c2"><a name="h.f3f4llieqx8c"></a><span>Channels and nodes</span></h2><p class="c2"><span>A buddycloud channel such as </span><span class="c0"><a class="c4" href="mailto:user@example.com">user@example.com</a></span><span>&nbsp;refers </span><span>to a bundle of pub-sub nodes. There are some well established nodes such as:</span></p><ol class="c11" start="1"><li class="c8 c2"><span>/user/name@</span><span>example.com/posts (micro-blog-like updates)</span></li><li class="c8 c2"><span>/user/name@</span><span>example.com/status (status updates like &quot;build is working&quot;)</span></li></ol><p class="c2 c5"><span></span></p><p class="c2"><span>Applications that use buddycloud can then add application-specific nodes that are prefixed with &quot;x-&quot;. for example</span></p><ol class="c11" start="3"><li class="c8 c2"><span>/user/name@example.com/x-faceblog</span></li></ol><p class="c2 c5"><span></span></p><p class="c2"><span>In this way different clients with different capabilities can query and update information relevant to their own use.</span></p><h2 class="c2"><a name="h.pp15h6jwejzn"></a><span>Resynchronising with remote domains</span></h2><p class="c2"><span>Posts from remote servers are treated as cached data with the &quot;truth&quot; available on the remote server. The buddycloud server is designed to treat data from remote buddycloud server as ephemeral and essentially a cache that can be resynchronised at any point in time.</span></p><h2 class="c2"><a name="h.s6kwnujdo8x2"></a><span>Strong Identity</span></h2><p class="c2"><span>buddycloud users&#39; identity is composed of &lt;username&gt;@&lt;domain&gt;. This fits with traditional schemes such as email </span><span class="c0"><a class="c4" href="mailto:name@example.com">name@example.com</a></span><span>&nbsp;and is something familiar to the user.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>buddycloud leverages the strong identity by virtue of using XMPP for federating between domains. The identity is bound to, authenticated against and stored in their home-domain&#39;s XMPP server. This means that a user could authenticate and access buddycloud services via any of the SASL authentication mechanisms.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>The default buddycloud install stores user passwords using </span><span class="c10">SCRAM</span><span>-</span><span class="c10">SHA256</span><span>-PLUS. There is also the option to authenticate against external services such as LDAP or SQL systems. </span></p><h2 class="c2"><a name="h.bpgc5hdunk4n"></a><span>Messaging</span></h2><p class="c2"><span>A user always posts to their local buddycloud server. That buddycloud server is then responsible for relaying on data to all the other buddycloud sites that include followers for that channel. Imagine a channel cats-pictures@domainA.com, with followers:</span></p><ol class="c11" start="1"><li class="c2 c8"><span>catlady@domainA.org</span></li><li class="c8 c2"><span>siamese@domainB.com</span></li><li class="c8 c2"><span>Ilovecats@domainB.com</span></li><li class="c8 c2"><span>catman@domainC.com</span></li></ol><p class="c2"><span>so when catlady@domainA.org posts to cats-pictures@domainA.com, the following messages are sent:</span></p><ol class="c11" start="1"><li class="c8 c2"><span>1 message to domainB.com (domainB then deduplicates and stores the post in the inbox service to ensure that both user: siamese and user ilovecats domain receive it)</span></li><li class="c8 c2"><span>1 message to domainC.com</span></li></ol><h3 class="c2"><a name="h.it59tzhbxh4p"></a><span>client to server messages</span></h3><p class="c2"><span>buddycloud enabled client software communicates with the users home-buddycloud site. Each buddycloud site that intends to run clients should publish their API into DNS. Clients (for example the android client, then look up their respective API server to connect to depending on the domain portion of the users buddycloud id. For example </span></p><p class="c2 c5"><span></span></p><p class="c2"><span>using the buddycloud HTTP API server and the buddycloud API. This uses HTTP </span></p><h3 class="c2"><a name="h.fyaih0gpjfby"></a><span>server to server messages</span></h3><p class="c2"><span>buddycloud server components use XMPP to exchange messages with other servers on their domain and also remote domains that are buddycloud enabled. For example: media-serverexample.com connects to and queries buddycloud-server.example.com and buddycloud.example.com will talk to buddycloud.example.org via XMPP.</span></p><h2 class="c2"><a name="h.mjhwqvkmrqj0"></a><span>Protocol checking</span></h2><p class="c2"><span>Occasionally minor changes and fixes are made to the buddycloud protocol.</span></p><p class="c2 c5"><span></span></p><p class="c2"><span>Protocol changes are codified into the buddycloud-inspector service. This web service remotely tests domains and checks protocol compatibility.</span></p></body></html>