<html>
<head>
<title>Get Started</title>
<meta name="url" content="get-started-new" />
<meta name="save_as" content="get-started-new.html" />
<meta name="order" content="4" />
<meta name="show_as_selected" content="get-started-new" />
<meta name="show_in_top_menu" content="false" />
<meta name="table_of_contents" content="true" />
</head>
<body>
    
  <p>
    You can access Buddycloud in many ways. The following steps quickly introduce you on how to exchange posts in a channel node, which is the most basic thing you can do with Buddycloud.
  </p>
  <p>
    This example uses Javascript (better suited for web apps) but you can use our <a href="https://demo.buddycloud.org/api">RESTful API</a> in order to build other apps such as mobile ones.
  </p>

  <h2>Create a user</h2>
  <div class="bs-example">
      <p>
          The following Javascript code snippet creates an account: <code><span class='generated-u'></span></code>.
      </p>
  </div>
  <div class="highlight">
      <pre>
          <code class="javascript">
        $.getScript("https://demo.buddycloud.com/scripts/primus/primus.js", function() {
          var socket = new Primus("https://demo.buddycloud.com");
          socket.on('open', function() {
            socket.send('xmpp.login',
            {
                jid: '<span class='generated-u'></span>',
                password: '<span class='generated-p'></span>',
                register: true
            });
          });
        });
          </code>
      </pre>
  </div>
  <div>
      <span class="btn btn-primary" id="create_user_test" onclick="createUser();">
          Try it yourself!
      </span>
      <code id="create_user_output" style="margin-left:10px; float:right; display:none;"></code>
  </div>

  <h2>Fetch posts</h2>
  <div class="bs-example">
      <p>
          The following Javascript code snippet authenticates your account and retrieves posts from the <code>get-started@demo.buddycloud.com/posts</code> node.
      </p>
  </div>
  <div class="highlight">
      <pre>
          <code class="javascript">
        $.getScript("https://demo.buddycloud.com/scripts/primus/primus.js", function() {
          var socket = new Primus("https://demo.buddycloud.com");
          socket.on('open', function() {
            socket.send('xmpp.login',
            {
              jid: '<span class='generated-u'></span>',
              password: '<span class='generated-p'></span>'
            });
          });
          socket.on('xmpp.connection', function(data) {
            socket.send('xmpp.buddycloud.discover', {}, function(error, data) {
              socket.send('xmpp.buddycloud.retrieve',
              {
                node: '/user/get-started@demo.buddycloud.com/posts',
                rsm: { max: 10 }
              },
              function(error, posts) {
                if (!error) {
                  /* handle display of existing posts */
                  posts.reverse().forEach(function(post) {
                    var author = post.entry.atom.author.name;
                    var content = post.entry.atom.content.content;
                    /* ...
                       handle display of this post */
                  });
                }
              });
            });
          });
        });
          </code>
      </pre>
  </div>
  <div>
      <span class="btn btn-primary" id="fetch_posts_test" onclick="fetchPosts();">
          Try it yourself!
      </span>
      <code id="fetch_posts_output" style="margin-left:10px; float:right; display:none;"></code>
  </div>

  <div id="posts_table_section" style="display:none">
      <h3 style="text-align:center;">Posts found:</h3>
      <div class="table-responsive" style="margin-top:30px;">
          <table class="table table-striped">
              <tbody id="posts_table"></tbody>
          </table>
      </div>
  </div>

  <h2>Post something yourself</h2>
  <div class="bs-example">
      <p>
          The following Javascript code snippet authenticates your account, subscribes your user to the <code>get-started@demo.buddycloud.com/posts</code> node and then creates a post on this node. Finally, it starts listening for incoming messages (and thus will receive the one you've just posted).
      </p>
  </div>
  <div class="highlight">
      <pre>
          <code class="javascript">
          $.getScript("https://demo.buddycloud.com/scripts/primus/primus.js", function(script) {
            var socket = new Primus("https://demo.buddycloud.com");
            socket.on('open', function() {
              socket.send('xmpp.login',
              {
                jid: '<span class='generated-u'></span>',
                password: '<span class='generated-p'></span>'
              });
            });
            socket.on('xmpp.connection', function() {
              socket.send('xmpp.buddycloud.discover', {}, function(error, data) {
                socket.send('xmpp.buddycloud.subscribe',
                {
                  node: '/user/get-started@demo.buddycloud.com/posts'
                },
                function(error, data) {
                  socket.send('xmpp.buddycloud.publish',
                  {
                    node: '/user/get-started@demo.buddycloud.com/posts',
                    content: {
                      atom: {
                        content: "Hello world!"
                      }
                    }
                  },
                  function(error, posts) {
                    if (!error) {
                      window.alert("Post created!");
                    }
                  });
                });
              });
            });
            socket.on('xmpp.buddycloud.push.item', function(post) {
                if ( post.node === '/user/get-started@demo.buddycloud.com/posts' ) {
                  var author = post.entry.atom.author.name;
                  var content = post.entry.atom.content.content;
                  /* ...
                     handle display of this post
                }
            });
          });
          </code>
      </pre>
  </div>
  <div>
      <span class="btn btn-primary" id="new_post_test" onclick="newPost();">
          Try it yourself!
      </span>
      <code id="new_post_output" style="margin-left:10px; float:right; display:none;"></code>
  </div>

  <script language="javascript" type="text/javascript">

      $.ajaxSetup({
        cache: true
      });

      var domain = "demo.buddycloud.com";
      var node = "/user/get-started@" + domain + "/posts";
      var url = "https://" + domain;
      var script = url + "/scripts";

      var createUser = function(uuid){
        var doCreateUser = function(){

	  $("#create_user_output").text("Working...");
          $("#create_user_test").removeAttr('onclick');
          $("#create_user_test").addClass('disabled');

          $.getScript(script + "/primus/primus.js", function() {

            var socket = new Primus(url);
            var jid = uuid + "@" + domain;
            var password = uuid + "_password";

            socket.on('open', function() {
              socket.send('xmpp.login',
                {
                  jid: jid,
                  password: password,
                  register: true
                }
              );
            });

            socket.on('xmpp.connection', function() {
              $("#create_user_output").text(jid + " created!");
              $("#create_user_output").show();
              $("#create_user_test").attr('onclick', "createUser();");
              $("#create_user_test").removeClass('disabled');
            });

            socket.on('xmpp.error', function(error) {
              if (error.description.indexOf("XMPP authentication") != -1){
                $("#create_user_output").text("Could not authenticate as " + jid + "!");
              }
              else {
                $("#create_user_output").text("Error: " + error.description);
              }
              $("#create_user_output").show();
              $("#create_user_test").attr('onclick', "createUser();");
              $("#create_user_test").removeClass('disabled');
            });
          });
        }
        return doCreateUser;
      }

      var fetchPosts = function(uuid){
        var doFetchPosts = function(){

          $("#fetch_posts_output").text("Working...");
          $("#fetch_posts_test").removeAttr('onclick');
          $("#fetch_posts_test").addClass('disabled');

          $.getScript(script + "/primus/primus.js", function(script) {

            var socket = new Primus(url);
            var jid = uuid + "@" + domain;
            var password = uuid + "_password";

            socket.on('open', function() {
              socket.send('xmpp.login',
              {
                jid: jid,
                password: password
              });
            });

            socket.on('xmpp.connection', function() {
              socket.send('xmpp.buddycloud.discover', {}, function(error, data) {
                if (error) {
                    console.error(error);
                }
                socket.send('xmpp.buddycloud.retrieve',
                {
                  node: node,
                  rsm: { max: 10 }
                },
                function(error, posts) {
                  if (!error) {
                    $("#fetch_posts_output").text("Fetched posts from " + node + "!");
                    $("#posts_table").empty();
                    $("#posts_table_section").show();
                    posts.reverse().forEach(function(post) {
                      var author = post.entry.atom.author.name;
                      var content = post.entry.atom.content.content;
                      $("#posts_table").append("<tr><th>" + author + "</th><td>" + content + "</td></tr>");
                    });
                  }
                  else {
                    $("#fetch_posts_output").text("Could not fetch from " + node + ": " + error.condition + "!");
                  }
                  $("#fetch_posts_output").show();
                  $("#fetch_posts_test").attr('onclick', "fetchPosts();");
                  $("#fetch_posts_test").removeClass('disabled');
                });
              });
            });

            socket.on('xmpp.error', function(error) {
              if (error.description.indexOf("XMPP authentication") != -1){
                $("#fetch_posts_output").text("Could not authenticate as " + jid + "!");
              }
              else {
                $("#fetch_posts_output").text("Error: " + error.description);
              }
              $("#fetch_posts_output").show();
              $("#fetch_posts_test").attr('onclick', "fetchPosts();");
              $("#fetch_posts_test").removeClass('disabled');
            });
          });
        }
        return doFetchPosts;
      }

      var newPost = function(uuid){
        var doNewPost = function(){

          $("#new_post_output").text("Working...");
          $("#new_post_test").removeAttr('onclick');
          $("#new_post_test").addClass('disabled');

          $.getScript(script + "/primus/primus.js", function() {

            var socket = new Primus(url);
            var jid = uuid + "@" + domain;
            var password = uuid + "_password";

            socket.on('open', function() {
              socket.send('xmpp.login',
              {
                jid: jid,
                password: password
              });
            });

            socket.on('xmpp.connection', function() {
              socket.send('xmpp.buddycloud.discover', {}, function(error, data) {
                if (error) {
                    console.error(error);
                }
                socket.send('xmpp.buddycloud.subscribe',
                {
                  node: node
                },
                function(error, data) {
                  if (error) {
                    $("#new_post_output").text("Could not subscribe to " + node + ": " + error.condition + "!");
                    $("#new_post_output").show();
                    $("#new_post_test").attr('onclick', "newPost();");
                    $("#new_post_test").removeClass('disabled');
                    return;
                  }
                  socket.send('xmpp.buddycloud.publish',
                  {
                    node: node,
                    content: {
                      atom: {
                        content: "Hello world!"
                      }
                    }
                  },
                  function(error, posts) {
                    if (!error) {
                      $("#new_post_output").text("Created post on " + node + "!");
                    }
                    else {
                      $("#new_post_output").text("Could not post on " + node + ": " + error.condition + "!");
                    }
                    $("#new_post_output").show();
                    $("#new_post_test").attr('onclick', "newPost();");
                    $("#new_post_test").removeClass('disabled');
                  });
                });
              });
            });

            socket.on('xmpp.buddycloud.push.item', function(post) {
                $("#posts_table_section").show();
                if ( post.node === node ) {
                  var author = post.entry.atom.author.name;
                  var content = post.entry.atom.content.content;
                  $("#posts_table").append("<tr><th>" + author + "</th><td>" + content + "</td></tr>");
                }
            });

            socket.on('xmpp.error', function(error) {
              if (error.description.indexOf("XMPP authentication") != -1){
                $("#new_post_output").text("Could not authenticate as " + jid + "!");
              }
              else {
                $("#new_post_output").text("Error: " + error.description);
              }
              $("#new_post_output").show();
              $("#new_post_test").attr('onclick', "newPost();");
              $("#new_post_test").removeClass('disabled');
            });
          });
        }
        return doNewPost;
      }

      $(window.document).ready(function(data){
          var uuid = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'.replace(/[xy]/g,
              function(c){
                  var r = Math.random()*16&#124;0, v = c == 'x' ? r : (r&#38;0x3&#124;0x8);
                  return v.toString(16);
          });

          var jid = uuid + "@" + domain;
          var password = uuid + "_password";
          $(".generated-u").text(jid);
          $(".generated-p").text(password);

          createUser = createUser(uuid);
          fetchPosts = fetchPosts(uuid);
          newPost = newPost(uuid);
      });
  </script>
</body>
</html>
